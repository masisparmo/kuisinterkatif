<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Interaktif Seminar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .btn { display: inline-block; text-align: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; color: white; transition: background-color 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .quiz-option { border: 1px solid #e5e7eb; cursor: pointer; }
        .quiz-option:hover { background-color: #f3f4f6; border-color: #4f46e5; }
        .quiz-option.selected { background-color: #e0e7ff; border-color: #4f46e5; color: #3730a3; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 50; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-container" class="max-w-xl w-full mx-auto p-4">

        <!-- ===== HALAMAN UTAMA (PEMILIHAN ROLE) ===== -->
        <div id="role-selection-page" class="card text-center">
            <h1 class="text-2xl font-bold text-gray-800">Selamat Datang!</h1>
            <p class="text-gray-500 mt-2 mb-8">Silakan pilih peran Anda untuk melanjutkan.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="showAdminLoginPage()" class="btn btn-primary">Saya Pembicara (Admin)</button>
                <button onclick="showParticipantPage()" class="btn btn-secondary">Saya Peserta</button>
            </div>
        </div>
        
        <!-- ===== MODAL ALERT ===== -->
        <div id="alert-modal" class="modal-backdrop hidden justify-center items-center">
            <div class="modal-content card w-11/12 max-w-sm text-center">
                <h3 id="alert-title" class="text-lg font-bold text-gray-800">Pemberitahuan</h3>
                <p id="alert-message" class="text-gray-600 my-4">Ini adalah pesan alert.</p>
                <button onclick="closeAlert()" class="btn btn-primary mx-auto">Tutup</button>
            </div>
        </div>

        <!-- ===== BAGIAN ADMIN ===== -->
        <div id="admin-section" class="hidden w-full space-y-6">
            <!-- Halaman Login Admin -->
            <div id="admin-login-page" class="card">
                <h2 class="text-xl font-bold text-center mb-6">Login Admin</h2>
                <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                <button onclick="loginAdmin()" class="btn btn-primary w-full mt-4">Login</button>
                <button onclick="showRoleSelectionPage()" class="btn btn-secondary w-full mt-2">Kembali</button>
            </div>

            <!-- Halaman Dashboard Admin -->
            <div id="admin-dashboard-page" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">1. Konfigurasi</h2>
                    <label for="google-sheet-url" class="block text-sm font-medium text-gray-700">URL Web App Google Sheet</label>
                    <input type="url" id="google-sheet-url" placeholder="Tempel URL dari Google Apps Script di sini" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    <button onclick="saveConfig()" class="btn btn-primary mt-3">Simpan Konfigurasi</button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-4">2. Buat Kuis dari PDF</h2>
                    <p class="text-sm text-gray-500 mb-3">Unggah e-book (PDF). AI akan membuatkan soal berdasarkan isinya.</p>
                    <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <button id="generate-quiz-btn" onclick="generateQuizFromPDF()" class="btn btn-primary w-full mt-4" disabled>Buat Soal dengan AI</button>
                    <div id="generation-loader" class="hidden mx-auto mt-4 loader"></div>
                    <p id="generation-status" class="text-center text-sm text-gray-500 mt-2"></p>
                </div>

                <div id="quiz-review-section" class="card hidden">
                    <h2 class="text-xl font-bold mb-4">3. Tinjau Soal</h2>
                    <div id="quiz-review-form" class="space-y-4"></div>
                    <button onclick="saveQuiz()" class="btn btn-primary w-full mt-6">Simpan & Aktifkan Kuis</button>
                </div>
                
                <div id="quiz-active-section" class="card hidden">
                    <h2 class="text-xl font-bold text-center mb-4">üéâ Kuis Siap Digunakan! üéâ</h2>
                    <p class="text-center text-gray-600">Bagikan QR Code atau link di bawah ini kepada peserta seminar.</p>
                    <div class="flex justify-center my-4">
                        <canvas id="qr-code"></canvas>
                    </div>
                    <p class="text-center font-mono bg-gray-100 p-2 rounded break-all" id="quiz-link"></p>
                    <button onclick="showLeaderboard()" class="btn btn-primary w-full mt-4">Lihat Leaderboard</button>
                </div>

                <div id="leaderboard-section" class="card hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üèÜ Leaderboard</h2>
                        <button onclick="fetchLeaderboard()" class="btn btn-secondary">Refresh</button>
                    </div>
                    <div id="leaderboard-loader" class="hidden mx-auto loader"></div>
                    <div id="leaderboard-content" class="overflow-x-auto"></div>
                    <button onclick="showAdminDashboard()" class="btn btn-secondary w-full mt-4">Kembali ke Dashboard</button>
                </div>
            </div>
        </div>

        <!-- ===== BAGIAN PESERTA ===== -->
        <div id="participant-section" class="hidden w-full">
            <!-- Halaman Pendaftaran Peserta -->
            <div id="register-page" class="card">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Kuis Interaktif Seminar</h1>
                    <p class="text-gray-500 mt-1">Isi data diri untuk memulai!</p>
                </div>
                <div id="quiz-not-ready-msg" class="text-center bg-yellow-100 p-3 rounded-lg text-yellow-800 hidden">
                    <p>Kuis belum dimulai oleh pembicara. Mohon tunggu sebentar.</p>
                </div>
                <form id="register-form" class="space-y-4 mt-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="company" class="block text-sm font-medium text-gray-700">Perusahaan / Institusi</label>
                        <input type="text" id="company" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">No. WhatsApp</label>
                        <input type="tel" id="phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="pt-4">
                        <button id="start-quiz-btn" type="submit" class="btn btn-primary w-full" disabled>Mulai Kuis</button>
                    </div>
                </form>
                 <button onclick="showRoleSelectionPage()" class="btn btn-secondary w-full mt-2">Kembali</button>
            </div>

            <!-- Halaman Kuis -->
            <div id="quiz-page" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <div id="question-counter" class="text-sm font-semibold text-indigo-600">Soal 1 / 5</div>
                    <div id="timer" class="text-sm font-bold text-gray-800 bg-gray-200 px-3 py-1 rounded-full">Waktu: 00:00</div>
                </div>
                <div class="mb-6">
                    <h2 id="question-text" class="text-lg font-semibold text-gray-900 text-center"></h2>
                </div>
                <div id="options-container" class="space-y-3"></div>
                <div class="mt-8">
                     <button id="next-btn" class="btn btn-primary w-full opacity-50" disabled>Selanjutnya</button>
                </div>
            </div>

            <!-- Halaman Hasil -->
            <div id="result-page" class="card hidden text-center">
                <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800 mt-4">Kuis Selesai!</h1>
                <p class="text-gray-600 mt-2">Terima kasih telah berpartisipasi.</p>
                <div class="mt-6 bg-indigo-50 p-4 rounded-lg">
                    <div class="flex justify-around">
                        <div>
                            <p class="text-sm text-gray-500">Jawaban Benar</p>
                            <p id="final-score" class="text-2xl font-bold text-indigo-600">0 / 5</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Waktu</p>
                            <p id="final-time" class="text-2xl font-bold text-indigo-600">00:00</p>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-6">Pemenang akan diumumkan di layar utama. Semoga beruntung!</p>
                <button onclick="showRoleSelectionPage()" class="btn btn-secondary w-full mt-4">Selesai</button>
            </div>
        </div>
    </div>

    <script>
    // --- GLOBAL STATE & CONFIG ---
    let appState = {
        adminPassword: "seminar-keren-2025", // Ganti password di sini
        googleSheetUrl: '',
        quizQuestions: [],
        quizIsActive: false,
        maxTime: 180, // 3 menit dalam detik
        participantData: {},
        quizTimer: null,
        quizSeconds: 0,
        userAnswers: [],
        selectedOption: null,
        currentQuestionIndex: 0
    };

    // --- DOM ELEMENTS ---
    const allPages = document.querySelectorAll('#app-container > div, #admin-section > div, #participant-section > div');
    const roleSelectionPage = document.getElementById('role-selection-page');
    // Admin
    const adminSection = document.getElementById('admin-section');
    const adminLoginPage = document.getElementById('admin-login-page');
    const adminDashboardPage = document.getElementById('admin-dashboard-page');
    const generateQuizBtn = document.getElementById('generate-quiz-btn');
    const googleSheetUrlInput = document.getElementById('google-sheet-url');
    const pdfUploadInput = document.getElementById('pdf-upload');
    const generationLoader = document.getElementById('generation-loader');
    const generationStatus = document.getElementById('generation-status');
    const quizReviewSection = document.getElementById('quiz-review-section');
    const quizReviewForm = document.getElementById('quiz-review-form');
    const quizActiveSection = document.getElementById('quiz-active-section');
    const leaderboardSection = document.getElementById('leaderboard-section');
    // Participant
    const participantSection = document.getElementById('participant-section');
    const registerPage = document.getElementById('register-page');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const quizNotReadyMsg = document.getElementById('quiz-not-ready-msg');
    const quizPage = document.getElementById('quiz-page');
    const resultPage = document.getElementById('result-page');
    const questionCounter = document.getElementById('question-counter');
    const timerEl = document.getElementById('timer');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const nextBtn = document.getElementById('next-btn');

    // --- UTILITY & PAGE NAVIGATION ---
    function showAlert(title, message) {
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-message').textContent = message;
        document.getElementById('alert-modal').classList.remove('hidden');
        document.getElementById('alert-modal').classList.add('flex');
    }

    function closeAlert() {
        document.getElementById('alert-modal').classList.add('hidden');
        document.getElementById('alert-modal').classList.remove('flex');
    }

    function showPage(pageElement) {
        allPages.forEach(p => p.classList.add('hidden'));
        if(adminSection.contains(pageElement) || pageElement === adminSection) {
            adminSection.classList.remove('hidden');
        } else if(participantSection.contains(pageElement) || pageElement === participantSection) {
            participantSection.classList.remove('hidden');
        }
        pageElement.classList.remove('hidden');
    }

    function showRoleSelectionPage() {
        showPage(roleSelectionPage);
    }

    function showAdminLoginPage() {
        showPage(adminLoginPage);
    }
    
    function showAdminDashboard() {
        showPage(adminDashboardPage);
    }

    function showParticipantPage() {
        showPage(participantSection);
        showPage(registerPage);
        checkQuizStatusForParticipant();
    }
    
    function showLeaderboard() {
        showPage(leaderboardSection);
        fetchLeaderboard();
    }

    // --- ADMIN FUNCTIONS ---
    function loginAdmin() {
        const password = document.getElementById('admin-password').value;
        if (password === appState.adminPassword) {
            showAdminDashboard();
        } else {
            showAlert("Login Gagal", "Password yang Anda masukkan salah.");
        }
    }

    function saveConfig() {
        const url = googleSheetUrlInput.value;
        if (url && url.startsWith('https://script.google.com/macros/s/')) {
            appState.googleSheetUrl = url;
            localStorage.setItem('googleSheetUrl', url);
            generateQuizBtn.disabled = false;
            showAlert("Sukses", "Konfigurasi berhasil disimpan.");
        } else {
            showAlert("Error", "URL Google Sheet tidak valid. Pastikan Anda menempelkan URL Web App yang benar.");
        }
    }

    async function generateQuizFromPDF() {
        const file = pdfUploadInput.files[0];
        if (!file) {
            showAlert("Error", "Silakan pilih file PDF terlebih dahulu.");
            return;
        }

        generationLoader.classList.remove('hidden');
        generationStatus.textContent = "Mengekstrak teks dari PDF...";
        generateQuizBtn.disabled = true;

        try {
            const pdfText = await extractTextFromPDF(file);
            generationStatus.textContent = "Teks berhasil diekstrak. Menghubungi AI untuk membuat soal...";
            
            const prompt = `Based on the following text from a document, create a multiple-choice quiz with exactly 5 questions. The questions should be relevant to the main topics of the text. For each question, provide 4 options (A, B, C, D), where one is the correct answer and the other three are plausible but incorrect distractors. Return the result as a JSON array of objects. Each object must have three keys: "question" (string), "options" (an array of 4 strings), and "answer" (the correct string from the options array). Do not include any explanation, just the JSON. The text is: \n\n---\n${pdfText.substring(0, 8000)}\n---`;
            
            const generatedQuestions = await callGeminiAPI(prompt);
            
            appState.quizQuestions = JSON.parse(generatedQuestions);
            displayQuizForReview();
            generationStatus.textContent = "Soal berhasil dibuat! Silakan tinjau di bawah.";
        } catch (error) {
            console.error(error);
            showAlert("Error", "Gagal membuat soal. " + error.message);
            generationStatus.textContent = "Terjadi kesalahan.";
        } finally {
            generationLoader.classList.add('hidden');
            generateQuizBtn.disabled = false;
        }
    }
    
    async function callGeminiAPI(prompt) {
        // This is the actual Gemini API call.
        // The API key is handled by the execution environment.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                // We ask the model to respond with JSON.
                responseMimeType: "application/json",
            }
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("Gemini API Error Body:", errorBody);
            throw new Error(`Gemini API request failed with status ${response.status}`);
        }

        const result = await response.json();
        
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            // The response from the API is a string containing JSON.
            const jsonText = result.candidates[0].content.parts[0].text;
            return jsonText;
        } else {
            console.error("Unexpected Gemini API response structure:", result);
            throw new Error("Failed to parse response from Gemini API.");
        }
    }


    function extractTextFromPDF(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const pdf = await pdfjsLib.getDocument({ data: event.target.result }).promise;
                    let textContent = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const text = await page.getTextContent();
                        textContent += text.items.map(s => s.str).join(' ');
                    }
                    resolve(textContent);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function displayQuizForReview() {
        quizReviewForm.innerHTML = '';
        appState.quizQuestions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'p-4 border rounded-lg';
            questionDiv.innerHTML = `
                <label class="block font-semibold">Soal ${index + 1}:</label>
                <input type="text" value="${q.question}" class="w-full border-gray-300 rounded-md mt-1 p-2" data-q-index="${index}" data-type="question">
                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    ${q.options.map((opt, i) => `
                        <div>
                            <label class="text-sm">Opsi ${i+1}:</label>
                            <input type="text" value="${opt}" class="w-full border-gray-300 rounded-md p-1" data-q-index="${index}" data-opt-index="${i}">
                        </div>
                    `).join('')}
                </div>
                <label class="block text-sm mt-2">Jawaban Benar:</label>
                <select class="border-gray-300 rounded-md p-1" data-q-index="${index}" data-type="answer">
                    ${q.options.map(opt => `<option value="${opt}" ${opt === q.answer ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            `;
            quizReviewForm.appendChild(questionDiv);
        });
        quizReviewSection.classList.remove('hidden');
    }

    function saveQuiz() {
        // Update quiz questions from the review form
        const updatedQuestions = [];
        document.querySelectorAll('#quiz-review-form > div').forEach((div, index) => {
            const question = div.querySelector('input[data-type="question"]').value;
            const options = Array.from(div.querySelectorAll('input[data-opt-index]')).map(inp => inp.value);
            const answer = div.querySelector('select[data-type="answer"]').value;
            updatedQuestions.push({ question, options, answer });
        });
        appState.quizQuestions = updatedQuestions;
        appState.quizIsActive = true;
        
        // Save to localStorage so participants can access it
        localStorage.setItem('quizQuestions', JSON.stringify(appState.quizQuestions));
        localStorage.setItem('quizIsActive', 'true');

        quizReviewSection.classList.add('hidden');
        quizActiveSection.classList.remove('hidden');
        
        const link = window.location.href.split('#')[0];
        document.getElementById('quiz-link').textContent = link;
        new QRious({
            element: document.getElementById('qr-code'),
            value: link,
            size: 200
        });

        showAlert("Sukses!", "Kuis telah disimpan dan diaktifkan. Peserta sekarang bisa memulai kuis.");
    }
    
    async function fetchLeaderboard() {
        const loader = document.getElementById('leaderboard-loader');
        const content = document.getElementById('leaderboard-content');
        loader.classList.remove('hidden');
        content.innerHTML = '';
        
        if (!appState.googleSheetUrl) {
            showAlert("Error", "URL Google Sheet belum dikonfigurasi.");
            loader.classList.add('hidden');
            return;
        }

        try {
            // We add a parameter to tell the script we want to GET data
            const response = await fetch(`${appState.googleSheetUrl}?action=getLeaderboard`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            if(data.success && data.leaderboard.length > 0) {
                let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Akhir</th>
                        </tr>
                    </thead><tbody class="bg-white divide-y divide-gray-200">`;
                
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                data.leaderboard.slice(0, 10).forEach((row, index) => {
                    tableHTML += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-lg font-bold">${medals[index] || index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${row.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-indigo-600 font-bold">${row.skorAkhir.toFixed(2)}</td>
                    </tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                content.innerHTML = tableHTML;
            } else {
                content.innerHTML = `<p class="text-center text-gray-500">Belum ada data peserta.</p>`;
            }

        } catch (error) {
            console.error("Error fetching leaderboard:", error);
            showAlert("Error", "Gagal memuat leaderboard. Periksa koneksi dan URL Google Sheet Anda.");
            content.innerHTML = `<p class="text-center text-red-500">Gagal memuat data.</p>`;
        } finally {
            loader.classList.add('hidden');
        }
    }


    // --- PARTICIPANT FUNCTIONS ---
    function checkQuizStatusForParticipant() {
        const isActive = localStorage.getItem('quizIsActive') === 'true';
        if (isActive) {
            appState.quizIsActive = true;
            appState.quizQuestions = JSON.parse(localStorage.getItem('quizQuestions'));
            startQuizBtn.disabled = false;
            quizNotReadyMsg.classList.add('hidden');
        } else {
            appState.quizIsActive = false;
            startQuizBtn.disabled = true;
            quizNotReadyMsg.classList.remove('hidden');
        }
    }

    function handleParticipantRegistration(e) {
        e.preventDefault();
        appState.participantData = {
            name: document.getElementById('name').value,
            company: document.getElementById('company').value,
            phone: document.getElementById('phone').value,
        };
        if (appState.participantData.name && appState.participantData.company) {
            startParticipantQuiz();
        }
    }

    function startParticipantQuiz() {
        showPage(quizPage);
        appState.quizSeconds = 0;
        appState.currentQuestionIndex = 0;
        appState.userAnswers = [];
        startQuizTimer();
        showNextQuestion();
    }

    function startQuizTimer() {
        appState.quizTimer = setInterval(() => {
            appState.quizSeconds++;
            const min = Math.floor(appState.quizSeconds / 60).toString().padStart(2, '0');
            const sec = (appState.quizSeconds % 60).toString().padStart(2, '0');
            timerEl.textContent = `Waktu: ${min}:${sec}`;
        }, 1000);
    }

    function showNextQuestion() {
        appState.selectedOption = null;
        nextBtn.disabled = true;
        nextBtn.classList.add('opacity-50');

        const q = appState.quizQuestions[appState.currentQuestionIndex];
        questionCounter.textContent = `Soal ${appState.currentQuestionIndex + 1} / ${appState.quizQuestions.length}`;
        questionText.textContent = q.question;
        optionsContainer.innerHTML = '';
        q.options.forEach(option => {
            const optEl = document.createElement('div');
            optEl.textContent = option;
            optEl.className = 'p-4 rounded-lg quiz-option';
            optEl.onclick = () => handleOptionSelect(optEl, option);
            optionsContainer.appendChild(optEl);
        });
    }
    
    function handleOptionSelect(optionEl, option) {
        optionsContainer.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
        optionEl.classList.add('selected');
        appState.selectedOption = option;
        nextBtn.disabled = false;
        nextBtn.classList.remove('opacity-50');
    }
    
    function handleNextQuestion() {
        if (appState.selectedOption) {
            appState.userAnswers.push(appState.selectedOption);
            appState.currentQuestionIndex++;
            if (appState.currentQuestionIndex < appState.quizQuestions.length) {
                showNextQuestion();
            } else {
                finishQuiz();
            }
        }
    }

    async function finishQuiz() {
        clearInterval(appState.quizTimer);
        let correctAnswers = 0;
        appState.userAnswers.forEach((answer, index) => {
            if (answer === appState.quizQuestions[index].answer) {
                correctAnswers++;
            }
        });

        const scoreJawaban = (correctAnswers / appState.quizQuestions.length) * 100;
        const timeTaken = appState.quizSeconds;
        const scoreWaktu = ((appState.maxTime - timeTaken) / appState.maxTime) * 100;
        const finalScore = (scoreJawaban * 0.75) + (Math.max(0, scoreWaktu) * 0.25);

        // Display results
        showPage(resultPage);
        document.getElementById('final-score').textContent = `${correctAnswers} / ${appState.quizQuestions.length}`;
        document.getElementById('final-time').textContent = timerEl.textContent.replace('Waktu: ', '');

        // Send data to Google Sheet
        const dataToSend = {
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
            name: appState.participantData.name,
            company: appState.participantData.company,
            phone: appState.participantData.phone,
            correctAnswers: correctAnswers,
            timeTaken: timeTaken,
            finalScore: finalScore
        };
        
        try {
            const sheetUrl = localStorage.getItem('googleSheetUrl');
            if(!sheetUrl) throw new Error("Sheet URL not found");

            await fetch(sheetUrl, {
                method: 'POST',
                mode: 'no-cors', // Important for sending to Google Apps Script from browser
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
        } catch (error) {
            console.error("Failed to send data to Google Sheet:", error);
            // Don't bother the user with this error, just log it.
        }
    }


    // --- INITIALIZATION ---
    window.onload = () => {
        // Event Listeners
        document.getElementById('register-form').addEventListener('submit', handleParticipantRegistration);
        nextBtn.addEventListener('click', handleNextQuestion);

        // Load saved config
        const savedUrl = localStorage.getItem('googleSheetUrl');
        if (savedUrl) {
            googleSheetUrlInput.value = savedUrl;
            appState.googleSheetUrl = savedUrl;
            generateQuizBtn.disabled = false;
        }

        // Check URL for routing
        if (window.location.hash === '#admin') {
            showAdminLoginPage();
        } else {
            showRoleSelectionPage();
        }
    };
    </script>
</body>
</html>
